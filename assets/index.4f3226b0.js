var A=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var s=(i,e,t)=>(A(i,e,"read from private field"),t?t.call(i):e.get(i)),l=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)},u=(i,e,t,n)=>(A(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t);const F=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerpolicy&&(o.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?o.credentials="include":r.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}};F();async function M(){const i=await fetch("./data.json");if(!i.ok)return console.error("api error!"),Promise.reject();const{page_images:e}=await i.json();return e}var C,h,v,I;class B{constructor(e){l(this,C,!1);l(this,h,void 0);l(this,v,void 0);l(this,I,void 0);u(this,h,e),u(this,v,this.createElement()),u(this,I,this.createCanvas(e.width,e.height)),s(this,v).appendChild(s(this,I))}get index(){return s(this,h).index}get element(){return s(this,v)}createElement(){const e=document.createElement("p");return e.classList.add("viewer-page"),e}createCanvas(e,t){const n=document.createElement("canvas");return n.classList.add("content"),n.setAttribute("width",`${e}`),n.setAttribute("height",`${t}`),n}loadImage(){if(s(this,C))return Promise.resolve();const e=s(this,I).getContext("2d");if(!e)return console.error("The rendering context is not ready."),Promise.reject();u(this,C,!0);const t=new Image;return t.src=typeof s(this,h).image=="string"?s(this,h).image:s(this,h).image.url,new Promise((n,r)=>{t.onload=()=>{this.drawPageImage(e,t),n()},t.onabort=t.onerror=r})}drawPageImage(e,t){const{width:n,height:r,image:o}=s(this,h),a=typeof o=="string"?{w:t.width,h:t.height,pieces:void 0}:o,c=n/r,d=a.w/a.h,g=c>d?d*r:n,E=c>d?r:n/d,b=(n-g)/2,L=(r-E)/2;if(a.pieces){const P=g/a.w,O=E/a.h;for(const f of a.pieces)e.drawImage(t,f.x,f.y,f.w,f.h,b+f.dx*P,L+f.dy*O,f.w*P,f.h*O)}else e.drawImage(t,b,L,g,E)}}C=new WeakMap,h=new WeakMap,v=new WeakMap,I=new WeakMap;const R=800,T=1200;var p,w,m,x,y;class ${constructor({pageImages:e,mode:t}){l(this,p,void 0);l(this,w,void 0);l(this,m,[]);l(this,x,0);l(this,y,[]);const[n,r]=this.createElements(t);u(this,p,n),u(this,w,r),u(this,m,this.createPages(r,e)),this.setupCurrentIndexChange();for(const o of s(this,m))o.loadImage()}get element(){return s(this,p)}get pages(){return s(this,m)}set currentIndex(e){const t=s(this,m).find(n=>n.index===e);!t||t.element.scrollIntoView()}get currentIndex(){return s(this,x)}next(){s(this,w).scrollBy({left:-1})}prev(){s(this,w).scrollBy({left:1})}canFullscreen(){return!!s(this,p).requestFullscreen}async fullscreen(){this.canFullscreen()&&await s(this,p).requestFullscreen()}onCurrentIndexChanged(e){s(this,y).push(e)}emitCurrentIndexChanged(e){u(this,x,e);for(const t of s(this,y))t(e)}setupCurrentIndexChange(){const e=new Set,t=new IntersectionObserver(n=>{for(const o of n){const a=s(this,m).find(c=>c.element===o.target);!a||(o.isIntersecting?e.add(a.index):e.delete(a.index))}if(e.size===0)return;const r=Math.min(...e);r!==s(this,x)&&this.emitCurrentIndexChanged(r)},{root:s(this,w),threshold:0});for(const n of s(this,m))t.observe(n.element);this.emitCurrentIndexChanged(0)}createElements(e){const t=document.createElement("section");t.classList.add("manga-viewer"),t.classList.add(`${e}-viewer`);const n=t.appendChild(document.createElement("div"));n.classList.add("viewer-main");const r=n.appendChild(document.createElement("div"));return r.classList.add("viewer-page-contents"),[t,r]}createPages(e,t){return t.map((n,r)=>{const o=new B({width:R,height:T,index:r,image:n});return e.appendChild(o.element),o})}}p=new WeakMap,w=new WeakMap,m=new WeakMap,x=new WeakMap,y=new WeakMap;window.addEventListener("DOMContentLoaded",async()=>{var o,a;console.debug("DOMContentLoaded");const i=document.getElementById("embed");if(!i){console.error("element not found");return}const e=await M(),t=new $({pageImages:e,mode:"horizontal"});i.appendChild(t.element);const n=document.createElement("select");for(let c=0;c<t.pages.length;c++){const d=document.createElement("option"),g=`${c+1}`;d.setAttribute("value",g),d.innerText=g,n.appendChild(d)}if(n.addEventListener("change",()=>{const c=parseInt(n.value)-1;t.currentIndex=c}),t.onCurrentIndexChanged(c=>{n.value=`${c+1}`}),document.body.appendChild(n),(o=document.getElementById("simple-next"))==null||o.addEventListener("click",()=>{t.next()}),(a=document.getElementById("simple-prev"))==null||a.addEventListener("click",()=>{t.prev()}),new ResizeObserver(c=>{const d=c.find(g=>g.target===t.element);!d||console.log(d.contentRect.width,d.contentRect.height)}).observe(t.element),t.canFullscreen()){const c=document.createElement("button");c.setAttribute("type","button"),c.innerText="full",c.addEventListener("click",()=>{t.fullscreen()}),document.body.append(c)}});console.debug("run");
